/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper");Ext.define("SYNO.SDS.NoteStationClipper.LoginDialog",{extend:"SYNO.SDS.BaseWindow",constructor:function(a){this.info=a.info;this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b=Ext.apply({padding:0,layout:"fit",maximized:true,maximizable:false,minimizable:false,closable:false,resizable:false,draggable:false,items:[this.formPanel=new SYNO.ux.FormPanel({xtype:"syno_formpanel",padding:"0px 18px",items:[{xtype:"syno_displayfield",height:72,value:this.getLogoValue(),itemCls:"syno-nsc-login-logo-item",cls:"syno-nsc-login-logo"},this.messageField=new SYNO.ux.DisplayField({hidden:true}),this.hostnameField=new SYNO.ux.TextField({emptyText:_NSC("message","hint_hostname"),hideLabel:true,allowBlank:false,selectOnFocus:true,itemCls:"syno-nsc-login-host-item",width:264}),this.httpsCheck=new SYNO.ux.Checkbox({boxLabel:"https",itemCls:"syno-nsc-login-https-item",hideLabel:true}),this.usernameField=new SYNO.ux.TextField({emptyText:_NSC("common","username"),hideLabel:true,allowBlank:false,selectOnFocus:true,itemCls:"syno-nsc-login-user-item",width:264}),this.passwordField=new SYNO.ux.TextField({textType:"password",emptyText:_NSC("common","password"),hideLabel:true,allowBlank:false,selectOnFocus:true,itemCls:"syno-nsc-login-password-item",width:264}),this.otpField=new SYNO.ux.NumberField({emptyText:_NSC("login","enter_otp_desc"),hideLabel:true,allowBlank:false,selectOnFocus:true,hidden:true,disabled:true,allowNegative:false,maxLength:8,validator:function(e){var d=/^[0-9]{6}$/;var c=/^[0-9]{8}$/;if(d.exec(e)||c.exec(e)){return true}return false},vtypeText:_NSC("login","otp_wrong_input_format"),listeners:{afterrender:function(d,c){d.el.set({maxlength:"8"},true)}},itemCls:"syno-nsc-login-otp-item",width:264}),this.enableDeviceCheck=new SYNO.ux.Checkbox({boxLabel:_NSC("login","trust_device"),itemCls:"syno-nsc-login-enable-device-item",hidden:true,hideLabel:true}),this.loginButton=new SYNO.ux.Button({btnStyle:"blue",text:_NSC("common","login"),itemCls:"syno-nsc-login-login-item",width:264,scope:this,handler:this.loginHandler}),this.otpLoginButton=new SYNO.ux.Button({btnStyle:"blue",text:_NSC("common","login"),itemCls:"syno-nsc-login-login-item",width:264,hidden:true,scope:this}),this.lostPhoneField=new SYNO.ux.DisplayField({value:_NSC("login","otp_lost_phone_desc"),itemCls:"syno-nsc-login-lost-phone-item",hidden:true}),this.errorMessageField=new SYNO.ux.DisplayField({itemCls:"syno-nsc-login-error-msg-item"})]})],bbar:{hidden:true,items:["->",{xtype:"syno_button",btnStyle:"blue",text:_JSLIBSTR("extlang","yes")},{xtype:"syno_button",btnStyle:"grey",text:_JSLIBSTR("extlang","no")}]},keys:[{key:Ext.EventObject.ENTER,scope:this,fn:function(){if(this.otpLoginButton.isVisible()){this.otpLoginButton.handler.call(this)}else{this.loginButton.handler.call(this)}}}],listeners:{afterrender:{fn:this.onAfterRender,scope:this,delay:100}}},a);return b},onAfterRender:function(){var a="",c="",b=false;if(Ext.isObject(this.info)){if(Ext.isString(this.info.USER)){c=this.info.USER}if(Ext.isString(this.info.SERVER)){a=this.info.SERVER}if(true===this.info.HTTPS){b=true}delete this.info}this.hostnameField.setValue(a);this.usernameField.setValue(c);this.passwordField.setValue("");this.httpsCheck.setValue(b);this.hostnameField.clearInvalid();this.usernameField.clearInvalid();this.passwordField.clearInvalid()},onWindowClosed:Ext.emptyFn,getLogoValue:function(){var a='<div class="syno-nsc-login-logo-corp">Synology</div>';a+='<div class="syno-nsc-login-logo-proj">Web Clipper</div>';if(SYNO.SDS.NoteStationClipper.Utils.checkIsBeta()){a+='<span class="syno-nsc-login-logo-beta">BETA</span>'}return a},getQuickConnectId:function(a,d){var c,b;if(new RegExp("^[\\w-]+$").test(a)){return a}if(new RegExp("^quickconnect.(to|cn)$","i").test(a)){if(d.length<2){return false}c=d.indexOf("/",1);if(c>=0){d=d.substring(1,c-1)}else{d=d.substring(1)}return d}b=a.match(new RegExp("^([^.]+)[.][a-zA-Z]+[.]quickconnect.(to|cn)$"));if(Ext.isArray(b)&&b.length>1){return b[1]}b=a.match(new RegExp("^([^.]+)[.]quickconnect.(to|cn)$"));if(Ext.isArray(b)&&b.length>1){return b[1]}return false},loginHandler:function(){var f,h,d,b="/",e;this.showCloseMessage("");if(!this.formPanel.getForm().isValid()){return}f=this.hostnameField.getValue();h=this.httpsCheck.getValue();d=document.createElement("a");if(false===new RegExp(/^http(s)?:\/\//).test(f)){var a="ftp://";if(Ext.form.VTypes.v6ip(f)){a+="["+f+"]"}else{a+=f}d.href=a}else{d.href=f}if(Ext.isEmpty(d.hostname)){this.hostnameField.markInvalid();return}f=d.host;b=d.pathname;this.hostnameField.setValue(f);e=this.getQuickConnectId(f,b);if(Ext.isString(e)){this.hostnameField.setValue(e);this.requestQuickConnect(e,h);return}var g=this.getCandidateHost(h,f,d);var i=this;var c=function(j){if(j===g.length){return}i.host=g[j];i.fetchLoginInfo({},function(k){if(j+1===g.length){i.showCloseMessage(SYNO.SDS.NoteStationClipper.Utils.getErrorMsg("SYNO.API.Info",k))}else{c(j+1)}})};c(0)},getCandidateHost:function(f,b,c){var a=[];var e=f?"https://":"http://";e+=b;a.push(e);if(Ext.isEmpty(c.port)){a.push(e+(f?":5001":":5000"))}var d=c.pathname.split("/");if(!Ext.isEmpty(d[1])){a.push(e+"/"+d[1])}return a},requestQuickConnect:function(a,b){this.el.mask(_NSC("common","loading"),"x-mask-loading");SYNO.SDS.NoteStationClipper.Utils.GetQuickConnectHost(a,b,function(d,c){this.el.unmask();if(true===d){this.host=c.host;this.fetchLoginInfo({quickconnect:true,quick_id:a})}else{this.showCloseMessage(c.msg)}},this)},sendOtpMail:function(b){var a=this.host+"/webman/mail_otp.cgi";Ext.Ajax.request({url:a,params:{username:this.usernameField.getValue()},scope:this,callback:function(d,c,g){var f=_T("login","unknown_otp_err");if(!c){this.showCloseMessage(f);return}try{g=JSON.parse(g.responseText)}catch(e){g={success:false}}if(g.success){f=_NSC("login","otp_mail_success")}else{if(Ext.isObject(g)&&Ext.isString(g.err)){if("otp_no_emergency_code"===g.err){f=_NSC("login","otp_no_emergency_code")}else{if("no_mail_address"===g.err){f=_NSC("login","no_mail_address")}else{if("mail_service_not_enable"===g.err){f=_NSC("login","mail_service_not_enable")}}}}}this.showCloseMessage(f)}})},fetchLoginInfo:function(a,b){this.el.mask(_NSC("common","loading"),"x-mask-loading");a=a||{};SYNO.SDS.NoteStationClipper.Utils.getAPIInfo(this.host,(function(d,h,c){var g,e;try{g=JSON.parse(c.responseText)}catch(f){}if(!h||!g||!g.success){this.el.unmask();if(Ext.isFunction(b)){b(g)}else{this.showCloseMessage(SYNO.SDS.NoteStationClipper.Utils.getErrorMsg("SYNO.API.Info",g))}return}e=g.data["SYNO.API.Auth"];if(!Ext.isObject(e)){e={path:"auth.cgi",maxVersion:3,minVersion:1}}a.loginPath=e.path;a.loginVersion=Math.min(e.maxVersion,6);this.requestLogin(a,b)}).createDelegate(this))},requestLogin:function(b,c){var e=false;var a=this.host+"/webapi/"+b.loginPath;var d={api:"SYNO.API.Auth",version:b.loginVersion,method:"login",format:"sid",session:"notestation",account:this.usernameField.getValue(),passwd:this.passwordField.getValue()};if(Ext.isObject(b)){if(!Ext.isEmpty(b.otp)){d.otp_code=b.otp}if(true===b.quickconnect){e=true}d=Ext.copyTo(d,b,"enable_device_token")}Ext.Ajax.request({url:a,params:d,scope:this,callback:function(g,i,f){this.el.unmask();if(i){var h=JSON.parse(f.responseText);if(h.success&&h.data.sid){this.checkNoteStationVersion({host:this.host,sid:h.data.sid,did:h.data.did,quickconnect:e})}else{if(h.error.code===403){this.otpField.enable();this.otpField.show();this.otpField.setWidth(this.usernameField.getWidth());this.otpLoginButton.show();this.lostPhoneField.show();this.messageField.hide();this.httpsCheck.hide();this.hostnameField.hide();this.hostnameField.disable();this.usernameField.hide();this.usernameField.disable();this.passwordField.hide();this.passwordField.disable();this.loginButton.hide();if(b.loginVersion>=6){this.enableDeviceCheck.show()}this.otpLoginButton.handler=function(){if(!this.otpField.isValid()){this.otpField.markInvalid();return}this.requestLogin({loginPath:b.loginPath,loginVersion:b.loginVersion,quickconnect:e,enable_device_token:this.enableDeviceCheck.getValue()?"yes":"no",otp:this.otpField.getValue()})};this.lostPhoneField.el.addListener("click",this.sendOtpMail,this)}else{this.showCloseMessage(SYNO.SDS.NoteStationClipper.Utils.getErrorMsg("SYNO.API.Auth",h))}}}else{if(Ext.isFunction(c)){c({})}}}})},checkNoteStationVersion:function(a){this.el.mask(_NSC("common","loading"),"x-mask-loading");SYNO.SDS.NoteStationClipper.Utils.checkNoteStationVersion(a,function(d,c){this.el.unmask();if(!d){this.showCloseMessage(String.format(_NSC("common","error_system"),_NSC("app","displayname")));return}if(!c.data.result[0].success){this.showCloseMessage(_NSC("message","error_install_note_station"))}else{if(parseInt(c.data.result[0].data.version.build,10)<154){this.showCloseMessage(_NSC("message","error_upgrade_note_station"))}else{if(!c.data.result[1].success){if(c.data.result[1].error.code===1011){this.showCloseMessage(_NSC("message","error_user_home_disabled"))}else{if(c.data.result[1].error.code===1047){this.showCloseMessage(_NSC("message","error_user_home_disabled"))}else{this.showCloseMessage(String.format(_NSC("common","error_system"),_NSC("app","displayname")))}}}else{var b={account:this.usernameField.getValue(),SID:a.sid,did:a.did,SERVER:this.hostnameField.getValue(),USER:this.usernameField.getValue(),HTTPS:this.httpsCheck.getValue(),HOST:a.host,QUICKCONNECT:a.quickconnect,uid:c.data.result[0].data.uid,version:c.data.result[0].data.version};chrome.runtime.sendMessage({action:"setup_appinfo",data:b});chrome.contextMenus.update("setting",{enabled:true});chrome.browserAction.setPopup({popup:""});chrome.tabs.query({active:true,windowType:"normal",currentWindow:true},function(e){chrome.runtime.sendMessage({action:"toggle_clipper",tab_id:e[0].id});window.close()})}}}},this)},hideLoginField:function(){this.hostnameField.hide();this.httpsCheck.hide();this.usernameField.hide();this.passwordField.hide();this.loginButton.hide();this.errorMessageField.hide()},showConfirm:function(f,d,a,c,b){var e=this.getBottomToolbar();this.hideLoginField();this.messageField.setValue(f);this.messageField.show();e.show();e.getComponent(1).setHandler(d,a);e.getComponent(2).setHandler(c,b);document.body.style.height="280px"},showCloseMessage:function(b){this.errorMessageField.setValue(b);var a=this.errorMessageField.getHeight()+360;document.body.style.height=a+"px"}});chrome.webRequest.onErrorOccurred.addListener(function(b){if(b.url.indexOf("auth.cgi")>=0||b.url.indexOf("query.cgi")>=0){switch(b.error){case"net::ERR_INSECURE_RESPONSE":case"net::ERR_CERT_COMMON_NAME_INVALID":case"net::ERR_CERT_DATE_INVALID":case"net::ERR_CERT_AUTHORITY_INVALID":var c=b.url.indexOf("/",10);var a=b.url.substr(0,c);LoginDialog.showConfirm(String.format(_NSC("message","error_https_certificate"),a),window.open.createDelegate(window,[a]),window,window.close,window);break;default:LoginDialog.showCloseMessage(String.format(_NSC("common","error_system"),_NSC("app","displayname")));break}}else{if(b.url.indexOf("pingpong.cgi")>=0){if(b.error==="net::ERR_CONNECTION_TIMED_OUT"){if(!LoginDialog.connectionSuccess){LoginDialog.connectionSuccess=true;LoginDialog.pingPongFailureCallback.call()}}}}},{urls:["*://*/webapi/auth.cgi*","*://*/webman/pingpong.cgi*","*://*/webapi/query.cgi*"],types:["xmlhttprequest"]});Ext.onReady(function(){chrome.runtime.sendMessage({action:"get_appinfo"},function(a){window.LoginDialog=new SYNO.SDS.NoteStationClipper.LoginDialog({info:a}).show()})});