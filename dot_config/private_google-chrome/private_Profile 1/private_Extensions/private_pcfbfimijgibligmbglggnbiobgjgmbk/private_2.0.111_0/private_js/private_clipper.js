/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper.Clipper");var STYLE_IFRAME;var STYLE_MAP={};var INHERIT_STYLE=["azimuth","border-collapse","border-spacing","caption-side","color","cursor","direction","elevation","empty-cells","font-family","font-size","font-style","font-variant","font-weight","font","letter-spacing","line-height","list-style-image","list-style-position","list-style-type","list-style","orphans","pitch-range","pitch","quotes","richness","speak-header","speak-numeral","speak-punctuation","speak","speech-rate","stress","text-align","text-indent","text-transform","visibility","voice-family","volume","white-space","widows","word-spacing"];Ext.apply(SYNO.SDS.NoteStationClipper.Clipper,{manifest:{},getDocumentTitle:function(){var b=document.getElementsByTagName("meta");for(var a=0;a<b.length;a++){if(b[a].getAttribute("property")=="og:title"){return b[a].getAttribute("content")}}return document.title},getArticleTitle:function(){var j,f,e,a,k,b;var g=document.getElementsByTagName("meta");var c=document.getElementsByTagName("h1");var h=c.length>0?c[0].innerText:"";for(var d=0;d<g.length;d++){if(g[d].getAttribute("name")==="twitter:title"){f=g[d].getAttribute("content")}else{if(g[d].getAttribute("property")==="og:title"){j=g[d].getAttribute("content")}else{if(g[d].getAttribute("name")==="application-name"){e=g[d].getAttribute("content")}else{if(g[d].getAttribute("itemprop")==="headline"){a=g[d].getAttribute("content")}else{if(g[d].getAttribute("itemprop")==="name"){k=g[d].getAttribute("content")}else{if(g[d].getAttribute("name")==="title"){b=g[d].getAttribute("content")}}}}}}}if(!Ext.isEmpty(j)){return j}else{if(!Ext.isEmpty(f)){return f}else{if(!Ext.isEmpty(a)){return a}else{if(!Ext.isEmpty(h)){return h}else{if(!Ext.isEmpty(e)){return e}else{if(!Ext.isEmpty(b)){return b}else{if(!Ext.isEmpty(k)){return k}}}}}}}return document.title},getFramePageById:function(c,a){var b="?";a=a||{};if(!Ext.isEmpty(a.title)){b+="title="+encodeURIComponent(a.title)}else{b+="title="+encodeURIComponent(this.getDocumentTitle())}if(true===a.is_gmail){b+="&website=gmail"}else{if(true===a.is_mailplus){b+="&website=mailplus"}}switch(c){case"SYNO_NoteStationClipper_Setting_Frame":return chrome.extension.getURL("setting.html"+b);case"SYNO_NoteStationClipper_Clipper_Frame":return chrome.extension.getURL("clipper.html"+b);case"SYNO_NoteStationClipper_Status_Frame":if(Ext.isEmpty(a.data)){a.data={}}return chrome.extension.getURL("status.html?status="+a.status+"&text="+encodeURIComponent(a.text)+"&desc="+encodeURIComponent(a.desc)+"&object_id="+a.data.object_id+"&ver="+a.data.ver);default:break}},getFrameClassById:function(a){switch(a){case"SYNO_NoteStationClipper_Setting_Frame":return"syno-nsc-setting-frame";case"SYNO_NoteStationClipper_Clipper_Frame":return"syno-nsc-clipper-frame";case"SYNO_NoteStationClipper_Status_Frame":return"syno-nsc-status-frame";default:break}},getFrameStyleById:function(b){var a="position: fixed !important; top: 10px !important; right: 20px !important; left: inherit !important; bottom: inherit !important;";a+="display: block; opacity: 1 !important; visibility: visible !important; z-index: 2147483649; !important";switch(b){case"SYNO_NoteStationClipper_Setting_Frame":return a+"width: 305px !important; height: 330px; !important";case"SYNO_NoteStationClipper_Clipper_Frame":return a+"width: 305px !important; height: 420px; !important";case"SYNO_NoteStationClipper_Status_Frame":return a+"width: 305px !important; height: 210px; !important";default:break}},closeFrameById:function(b){var a=document.getElementById(b);if(a!==null){if(document.body.contains(a)){document.body.removeChild(a)}else{document.documentElement.removeChild(a)}}},openFrameById:function(f,b){var d=document.getElementById(f);if(d===null){var e=SYNO.SDS.NoteStationClipper.Clipper.getFramePageById(f,b);var a=SYNO.SDS.NoteStationClipper.Clipper.getFrameClassById(f);var c=SYNO.SDS.NoteStationClipper.Clipper.getFrameStyleById(f);d=document.createElement("iframe");d.setAttribute("id",f);d.setAttribute("src",e);d.setAttribute("style",c);d.setAttribute("scrolling","no");d.setAttribute("frameborder","0");d.setAttribute("class",a);document.documentElement.appendChild(d)}},closeAllOtherFrame:function(a){if(a!=="SYNO_NoteStationClipper_Setting_Frame"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Setting_Frame")}if(a!=="SYNO_NoteStationClipper_Clipper_Frame"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Clipper_Frame")}if(a!=="SYNO_NoteStationClipper_Status_Frame"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Status_Frame")}if(a!=="SYNO_NoteStationClipper_Simplify_Frame"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Simplify_Frame")}if(a!=="SYNO_NoteStationClipper_Screenshot_Mask"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Screenshot_Mask")}if(a!=="SYNO_NoteStationClipper_Screenshot_Focus"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Screenshot_Focus")}if(a!=="SYNO_NoteStationClipper_Screenshot_Image"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Screenshot_Image")}if(a!=="SYNO_NoteStationClipper_Gmail_Thread"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Gmail_Thread")}if(a!=="SYNO_NoteStationClipper_MailPlus_Thread"){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_MailPlus_Thread")}},closeSettingFrame:function(){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Setting_Frame")},closeClipperFrame:function(){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Clipper_Frame")},closeStatusFrame:function(){SYNO.SDS.NoteStationClipper.Clipper.closeFrameById("SYNO_NoteStationClipper_Status_Frame")},openSettingFrame:function(){SYNO.SDS.NoteStationClipper.Clipper.openFrameById("SYNO_NoteStationClipper_Setting_Frame")},openClipperFrame:function(a){SYNO.SDS.NoteStationClipper.Clipper.openFrameById("SYNO_NoteStationClipper_Clipper_Frame",a)},openStatusFrame:function(a){SYNO.SDS.NoteStationClipper.Clipper.closeStatusFrame();SYNO.SDS.NoteStationClipper.Clipper.openFrameById("SYNO_NoteStationClipper_Status_Frame",a)},hideClipperFrame:function(){var a=document.getElementById("SYNO_NoteStationClipper_Clipper_Frame");if(a!==null){a.style.display="none"}},showClipperFrame:function(){var a=document.getElementById("SYNO_NoteStationClipper_Clipper_Frame");if(a!==null){a.style.display="block"}},toggleSettingFrame:function(){var a=document.getElementById("SYNO_NoteStationClipper_Setting_Frame");if(a===null){SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame("SYNO_NoteStationClipper_Setting_Frame");SYNO.SDS.NoteStationClipper.Clipper.openSettingFrame()}else{SYNO.SDS.NoteStationClipper.Clipper.closeSettingFrame()}},toggleClipperFrame:function(){var c=document.getElementById("SYNO_NoteStationClipper_Clipper_Frame");var a={};a.url=document.location.href;if(SYNO.SDS.NoteStationClipper.Utils.isGmail(a.url)){var b=new window.Gmail();if(b.check.is_inside_email()){a.is_gmail=true;a.title=b.get.email_subject()}}else{if(SYNO.SDS.NoteStationClipper.Utils.isMailPlusBody(document.body)){a.is_mailplus=true;a.title=document.body.querySelector(".syno-mc-message-panel .subject").textContent}}if(c===null){SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame("SYNO_NoteStationClipper_Clipper_Frame");SYNO.SDS.NoteStationClipper.Clipper.openClipperFrame(a)}else{SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame();Ext.fly(document.body).setOverflow(SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW)}},toggleStatusFrame:function(a){var b=document.getElementById("SYNO_NoteStationClipper_Status_Frame");if(b===null){SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame("SYNO_NoteStationClipper_Status_Frame");SYNO.SDS.NoteStationClipper.Clipper.openStatusFrame(a)}else{SYNO.SDS.NoteStationClipper.Clipper.closeStatusFrame()}},applyCSSStyleRule:function(g,f){try{var c=f.querySelectorAll(g.selectorText);for(var a=0;a<c.length;a++){var b=c[a];b.style.cssText+=";"+g.style.cssText;b.cssText+=";"+g.cssText}}catch(d){}return false},applyCSSRules:function(a,d){for(var b=0;b<a.length;b++){var c=a[b];if(c instanceof window.CSSStyleRule){this.applyCSSStyleRule(c,d)}if(c.hasOwnProperty("cssRules")){this.applyCSSRules(c.cssRules,d)}}},serializeBody:function(c){for(var a=0;a<document.styleSheets.length;a++){var b=document.styleSheets[a];if(!b.hasOwnProperty("cssRules")){continue}this.applyCSSRules(b.cssRules,c)}},createNote:function(a){var c=a.data.title||this.getDocumentTitle();SYNO.SDS.NoteStationClipper.Clipper.openStatusFrame({status:"processing",text:_NSC("common","msg_waiting"),desc:c});var b={title:c,content:a.content,brief:a.brief,source_url:a.url,tag:a.data.tags,encrypt:false,commit_msg:{first_version:false,device:"clipper"},parent_id:a.data.notebook_id};chrome.runtime.sendMessage({action:"create_note",data:{paramInfo:{params:b,files:a.files}}},SYNO.SDS.NoteStationClipper.Clipper.createNoteCallback.createDelegate(this))},createNoteCallback:function(a){SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame();Ext.fly(document.body).setOverflow(SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW);if(!a.success){alert(_NSC("common","commfail"));return}var b=Ext.util.JSON.decode(a.response.responseText);if(!b.success){SYNO.SDS.NoteStationClipper.Clipper.openStatusFrame({status:"failure",text:_NSC("message","capture_fail"),desc:"Something went wrong. Please try again. Error code :"+b.error.code})}else{SYNO.SDS.NoteStationClipper.Clipper.openStatusFrame({status:"success",text:_NSC("message","capture_success"),desc:a.opt.params.title,data:b.data})}},getDocumentFromClipType:function(b){var c;switch(b){case"fullpage":c=document.cloneNode(true);break;case"simplified":var a=document.getElementById("SYNO_NoteStationClipper_Simplify_Frame");if(!Ext.isEmpty(a)){c=a.contentWindow.document.cloneNode(true)}break;case"screenshot":var d=document.getElementById("SYNO_NoteStationClipper_Screenshot_Image");if(!Ext.isEmpty(d)){c=d.cloneNode(true)}break;default:break}return c},getMailPlusThreadContent:function(a){var b;b=document.getElementById("SYNO_NoteStationClipper_MailPlus_Thread");if(!Ext.isElement(b)){return}b.contentWindow.postMessage({action:"get_content",data:a},b.src)},saveMailPlusContent:function(a){if(!Ext.isEmpty(a.data.comment)){a.content=a.data.comment+"<hr />"+a.content}SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame();SYNO.SDS.NoteStationClipper.Clipper.createNote({action:"send",data:a.data,url:window.location.href,files:a.files,brief:a.brief,content:a.content})},getGmailThreadContent:function(a){SYNO.SDS.NoteStationClipper.Gmail.getContent(function(c){var b;SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame();if(Ext.isEmpty(c)){alert("failed to get page content");return}b=document.createElement("div");b.setAttribute("class","syno-clipper-gmail-thread-container");b.innerHTML=c.content;SYNO.SDS.NoteStationClipper.Clipper.createNote({action:"send",data:a,url:window.location.href,files:c.files,brief:b.innerText.trim().substr(0,80),content:b.outerHTML})})},removeNonUseTag:function(b){for(var a=b.childNodes.length-1;a>=0;a--){var c=b.childNodes[a];switch(c.nodeName){case"STYLE":case"LINK":case"SCRIPT":case"META":case"NOSCRIPT":case"IFRAME":case"#comment":Ext.removeNode(c);break;default:break}}Ext.iterate(b.querySelectorAll("script, style, link, iframe"),function(d){Ext.removeNode(d)})},copyBody:function(c,e,a){var b;var d=e.createElement("div");d.setAttribute("class",a);while(e.body.firstChild){d.appendChild(e.body.firstChild)}b=window.getComputedStyle(c.body);d.style.width=b.width;d.style.height=b.height;d.style.overflow=b.overflow;return d},getFullContent:function(d,a){SYNO.SDS.NoteStationClipper.Clipper.closeClipperFrame();var e=SYNO.SDS.NoteStationClipper.Clipper.getDocumentFromClipType(a);if(Ext.isEmpty(e)){alert("failed to get page content");return}SYNO.SDS.NoteStationClipper.Clipper.convertAllCSS(document,e);SYNO.SDS.NoteStationClipper.Clipper.removeNonUseTag(e.body);var c=SYNO.SDS.NoteStationClipper.Utils.getImageFiles(e);c=SYNO.SDS.NoteStationClipper.Utils.getPdfFiles(c,e);var f=SYNO.SDS.NoteStationClipper.Clipper.copyBody(document,e,"syno-clipper-full-content-container");var b=Ext.isEmpty(d.comment)?f.outerHTML:d.comment+"<hr>"+f.outerHTML;SYNO.SDS.NoteStationClipper.Clipper.createNote({action:"send",data:d,url:window.location.href,files:c,brief:document.body.innerText.substr(0,80),content:b})},getSimplifyContent:function(b){SYNO.SDS.NoteStationClipper.Clipper.closeClipperFrame();var a=document.getElementById("SYNO_NoteStationClipper_Simplify_Frame");a.contentWindow.postMessage({action:"get_tinymce_content",data:b},a.src)},saveSimplifyContent:function(e){var d=document.createElement("div");var c=SYNO.SDS.NoteStationClipper.Clipper.Files;d.innerHTML=e.content;var b=Ext.isEmpty(e.data.comment)?e.content:e.data.comment+"<hr />"+e.content;var a=d.innerText.substr(0,80);SYNO.SDS.NoteStationClipper.Clipper.createNote({action:"send",data:e.data,url:window.location.href,files:c,brief:a,content:b})},getScreenShot:function(e,b){SYNO.SDS.NoteStationClipper.Clipper.closeClipperFrame();var f=SYNO.SDS.NoteStationClipper.Clipper.getDocumentFromClipType(b);if(Ext.isEmpty(f)){alert("failed to get page content");return}var d=SYNO.SDS.NoteStationClipper.Utils.getImageFiles(f,{convert:false});var a=f.innerHTML;var c=Ext.isEmpty(e.comment)?a:e.comment+"<hr>"+a;SYNO.SDS.NoteStationClipper.Clipper.createNote({action:"send",data:e,url:window.location.href,files:d,brief:"",content:c})},getFullScreenshotCallback:function(a){SYNO.SDS.NoteStationClipper.Clipper.openStatusFrame({status:"processing",text:_NSC("common","msg_waiting"),desc:"extracting the whole screenshot"});window.setTimeout(function(){var f=document.createElement("div");var b=document.createElement("img");b.setAttribute("src",a.canvas.toDataURL("image/jpeg",1));f.appendChild(b);var e=SYNO.SDS.NoteStationClipper.Utils.getImageFiles(f,{convert:false});var c=f.innerHTML;var d=Ext.isEmpty(a.data.comment)?c:a.data.comment+"<hr>"+c;SYNO.SDS.NoteStationClipper.Clipper.createNote({action:"send",data:a.data,url:window.location.href,files:e,brief:"",content:d})},1000)},getContent:function(a){switch(a.type){case"fullpage":SYNO.SDS.NoteStationClipper.Clipper.getFullContent(a,a.type);break;case"simplified":SYNO.SDS.NoteStationClipper.Clipper.getSimplifyContent(a);break;case"screenshot":SYNO.SDS.NoteStationClipper.Clipper.getScreenShot(a,a.type);break;case"whole_screenshot":SYNO.SDS.NoteStationClipper.Screenshot.getFullScreenshot(a,this.getFullScreenshotCallback);break;case"gmail_thread":SYNO.SDS.NoteStationClipper.Clipper.getGmailThreadContent(a);break;case"mailplus_thread":SYNO.SDS.NoteStationClipper.Clipper.getMailPlusThreadContent(a);break;default:alert("wrong type of getcontent action");break}},messageHandler:function(d,c,a){var b=false;switch(d.action){case"toggle_clipper":SYNO.SDS.NoteStationClipper.Clipper.toggleClipperFrame();b=true;break;case"toggle_setting":SYNO.SDS.NoteStationClipper.Clipper.toggleSettingFrame();b=true;break;case"close_all_frame":SYNO.SDS.NoteStationClipper.Clipper.closeAllOtherFrame("");b=true;break;case"close_status":SYNO.SDS.NoteStationClipper.Clipper.closeStatusFrame();b=true;break;case"toggle_simplify":SYNO.SDS.NoteStationClipper.Simplify.toggleSimplifyView(d.type,a);break;case"toggle_screenshot":SYNO.SDS.NoteStationClipper.Screenshot.toggleScreenshotView(d.type,a);break;case"toggle_gmail_thread":SYNO.SDS.NoteStationClipper.Gmail.toggleGmailThreadView(d.type,d.data,a);break;case"toggle_mailplus_thread":SYNO.SDS.NoteStationClipper.MailPlus.toggleMailPlusThreadView(d.type,d.data,a);break;case"get_content":SYNO.SDS.NoteStationClipper.Clipper.getContent(d.data);b=true;break;default:break}if(b&&Ext.isFunction(a)){a()}return true},addStyleIframe:function(){if(undefined!==STYLE_IFRAME){return}STYLE_IFRAME=document.body.appendChild(document.createElement("iframe"));STYLE_MAP.SPAN=window.getComputedStyle(STYLE_IFRAME.contentDocument.body.appendChild(document.createElement("span")));STYLE_MAP.DIV=window.getComputedStyle(STYLE_IFRAME.contentDocument.body.appendChild(document.createElement("div")));STYLE_MAP.A=window.getComputedStyle(STYLE_IFRAME.contentDocument.body.appendChild(document.createElement("a")))},delStyleIframe:function(){if(undefined!==STYLE_IFRAME){Ext.removeNode(STYLE_IFRAME);STYLE_IFRAME=undefined;STYLE_MAP={}}},getDefaultComputedStyle:function(a){if(!STYLE_MAP.hasOwnProperty(a.nodeName)){STYLE_MAP[a.nodeName]=window.getComputedStyle(STYLE_IFRAME.contentDocument.body.appendChild(document.createElement(a.nodeName)))}return STYLE_MAP[a.nodeName]},convertRuleStyle:function(g,f,d,c){for(var b=d.length-1;b>=0;b--){var a=d[b];var e=d.getPropertyValue(a);if(0===a.indexOf("-webkit-")){continue}if(e!==f.getPropertyValue(a)||(INHERIT_STYLE.includes(a)&&c&&e!==c.getPropertyValue(a))){g.style[a]=e}}},convertAllCSS:function(e,f){var b=function(g){switch(g.nodeName){case"STYLE":case"LINK":case"SCRIPT":case"META":case"NOSCRIPT":case"IFRAME":return;default:return NodeFilter.FILTER_ACCEPT}};var a=e.createTreeWalker(e.body,NodeFilter.SHOW_ELEMENT,{acceptNode:b});var d=f.createTreeWalker(f.body,NodeFilter.SHOW_ELEMENT,{acceptNode:b});SYNO.SDS.NoteStationClipper.Clipper.addStyleIframe();var c=(function(g){var k=a.currentNode;var j=d.currentNode;if(!k||!j){return}var i=window.getComputedStyle(k);var h=SYNO.SDS.NoteStationClipper.Clipper.getDefaultComputedStyle(k);this.convertRuleStyle(j,h,i,g);j.removeAttribute("class");j.removeAttribute("id");if(a.firstChild()){d.firstChild();c(i)}if(a.nextSibling()){d.nextSibling();c(g)}else{a.parentNode();d.parentNode()}}).bind(this);c(null);SYNO.SDS.NoteStationClipper.Clipper.delStyleIframe()},loadManifestInfo:function(){SYNO.SDS.NoteStationClipper.Clipper.manifest=Ext.apply({},chrome.runtime.getManifest())}});chrome.runtime.onMessage.addListener(SYNO.SDS.NoteStationClipper.Clipper.messageHandler);SYNO.SDS.NoteStationClipper.Clipper.loadManifestInfo();SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW=document.body.style.overflow;window.addEventListener("message",function(a){var b;if(Ext.isObject(a.data)&&"SYNOGmailGlobals"===a.data.name&&a.origin==="https://mail.google.com"){window.GLOBALS=JSON.parse(a.data.globals);return}b=document.getElementById("SYNO_NoteStationClipper_Simplify_Frame");if(b&&a.source==b.contentWindow.window&&a.data.baseUrl===chrome.runtime.getURL("")){if(a.data.action==="save_tinymce_content"){SYNO.SDS.NoteStationClipper.Clipper.saveSimplifyContent(a.data)}return}b=document.getElementById("SYNO_NoteStationClipper_MailPlus_Thread");if(b&&a.source===b.contentWindow){if(a.data.action==="save_content"){SYNO.SDS.NoteStationClipper.Clipper.closeClipperFrame();SYNO.SDS.NoteStationClipper.Clipper.saveMailPlusContent(a.data)}return}});if(SYNO.SDS.NoteStationClipper.Utils.isGmail(window.location.href)){SYNO.SDS.NoteStationClipper.Utils.installUxCSS(document);SYNO.SDS.NoteStationClipper.Utils.installGmail(document)};