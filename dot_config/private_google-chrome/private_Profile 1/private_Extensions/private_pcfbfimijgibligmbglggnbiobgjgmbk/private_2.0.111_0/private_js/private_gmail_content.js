/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper.Gmail");Ext.apply(SYNO.SDS.NoteStationClipper.Gmail,{choose_id:"SYNO_NoteStationClipper_Gmail_Thread",gmail_panel:null,gmail_data:null,removeAllClasses:function(a){a.removeAttribute("class");Ext.iterate(a.querySelectorAll("*[class]"),function(b){b.removeAttribute("class")});return a},getContent:function(d){var c=document.createElement("div"),b={},a;if(!Ext.isFunction(d)){return}if(!this.gmail_panel){d();return}a=this.gmail_panel.find("checked",true);if(Ext.isEmpty(a)&&false===window.confirm(_NSC("capture","only_mail_title"))){chrome.runtime.sendMessage({action:"unmask_clipper"});return}SYNO.SDS.NoteStationClipper.Clipper.serializeBody(this.gmail_panel.body.dom);Ext.iterate(a,function(e){var h,f,g;if(e.xtype!=="syno_checkbox"||"select_all"===e.itemId){return}if(!Ext.isFunction(e.nextSibling)){return}g=e.nextSibling();h=g.nextSibling();if(Ext.isEmpty(h)){return}f=h.getComponent("content");c.innerHTML+=String.format("<div>{0}</div>",e.boxLabel);c.innerHTML+=String.format('<div class="{0}" style="color: #00B8E6">{1}</div>',g.initialConfig.cls,g.getValue());c.innerHTML+=this.removeAllClasses(f.el.dom).innerHTML;if(!Ext.isEmpty(this.gmail_data.threads[e.thread_id].attachments)){c.innerHTML+='<div style="color: #505A64"><b>'+_NSC("mail","attachment")+"</b></div>"}Ext.iterate(this.gmail_data.threads[e.thread_id].attachments_details,function(j){var i=e.thread_id+"_att_"+j.attachment_id;c.innerHTML+=String.format('<a style="color: #505A64" href="#" file_ref="{0}">{1}</a><br>',i,Ext.util.Format.htmlEncode(j.name));b[i]={action:"create",format:"raw",name:j.name,rotate:false,fetch_url:j.fetch_url,file_ref:i}});c.innerHTML+="<hr>"},this);Ext.apply(b,SYNO.SDS.NoteStationClipper.Utils.getImageFiles(c,undefined,{is_gmail:true,gmail_data:this.gmail_data}));d({content:c.innerHTML,files:b})},getThreadFiles:function(a){var b="",d='<div class="syno-nsc-gmail-attachment-header" style="color: #505A64"><b>'+_NSC("mail","attachment")+"</b></div>";var c='<div class="syno-nsc-gmail-attachment-item" style="color: #505A64;">{0}</div>';if(!a||Ext.isEmpty(a.attachments)){return b}Ext.iterate(a.attachments_details,function(e){b+=String.format(c,Ext.util.Format.htmlEncode(e.name));e.fetch_url=e.url},this);return d+b},calculateSelectAll:function(a){var c,b=true;if(!Ext.isObject(a)){return}Ext.iterate(a.findByType("syno_checkbox"),function(d){if(d.itemId==="select_all"){c=d;return}if(false===d.getValue()){b=false;return false}});c.setValue(b)},openGmailThreadView:function(d,a){var c,b=this;b.gmail_panel=new SYNO.ux.FormPanel({cls:"syno-nsc-gmail-thread-panel",id:this.choose_id,border:false,frame:false,renderTo:document.body,width:document.body.offsetWidth,height:document.body.offsetHeight,hideLabel:true,hideLabels:true,autoFlexcroll:false,autoScroll:false,bodyCfg:{cls:"syno-nsc-gmail-thread-content"},items:[]});c=new window.Gmail();c.get.email_data_async(undefined,function(f){var h,g,e=b.gmail_panel;b.gmail_data=f;h=Ext.util.Format.htmlEncode(f.subject);e.add({xtype:"syno_displayfield",itemId:"subject",cls:"syno-nsc-gmail-title-area",original:h,html:'<div class="syno-nsc-gmail-title-icon"></div><div class="syno-nsc-gmail-title-text">'+h+"</div>"});e.add({xtype:"syno_checkbox",itemId:"select_all",wrapCls:"syno-ux-form-check-wrap syno-nsc-gmail-title-select-all",checked:true,boxLabel:"Select All",onClick:function(j){var i=!this.checked;if(!this.disabled&&!this.readOnly){this.setValue(i);Ext.iterate(e.findByType("syno_checkbox"),function(l,k){if(l.itemId==="select_all"){return}l.setValue(i)})}}});g=new SYNO.ux.Panel({bodyCssClass:"syno-nsc-gmail-content-panel-body",border:false,frame:false,height:document.body.offsetHeight-90,autoScroll:true,items:[]});Ext.iterate(f.total_threads,function(k){var j,i;if(!f.threads.hasOwnProperty(k)){return}j=f.threads[k];i=b.getThreadFiles(j);g.add([{xtype:"syno_checkbox",thread_id:k,checked:true,wrapCls:"syno-ux-form-check-wrap syno-nsc-gmail-sender",boxLabel:String.format('<span class="syno-nsc-gmail-sender-name" style="color: #505A64">{0}</span> <span class="syno-nsc-gmail-sender-mail"  style="color: #96A0AA;">{1}</span>',Ext.util.Format.htmlEncode(j.from),Ext.util.Format.htmlEncode(j.from_email)),handler:function(o,n){var l=g.find("thread_content_id",o.thread_id),m;if(!Ext.isEmpty(l)){m=l[0];if(n&&m.collapsed){m.expand()}else{if(!n&&!m.collapsed){m.collapse()}}}b.calculateSelectAll(e)}},{xtype:"syno_displayfield",cls:"syno-nsc-gmail-receive-time",name:"receive_time",style:{color:"#00B8E6"},value:new Date(j.timestamp).toLocaleString()},{xtype:"syno_panel",thread_content_id:k,itemId:k,items:[{xtype:"syno_displayfield",cls:"syno-nsc-gmail-content",itemId:"content",html:SYNO.SDS.NoteStationClipper.Utils.simplifyGmailContent(j.content_html)},{xtype:"syno_displayfield",itemId:"attachment",cls:"syno-nsc-gmail-attachment-split",html:i}]},{html:"<hr>"}])});e.add(g);e.doLayout();a({msg:"openGmailThreadView done"})})},toggleGmailThreadView:function(b,d,a){var c=document.getElementById(this.choose_id);if(b&&Ext.isEmpty(c)){this.openGmailThreadView(d,a)}else{if(!b&&!Ext.isEmpty(c)){document.body.removeChild(c);this.gmail_panel=null;this.gmail_data=null;this.gmail_files=0;Ext.fly(document.body).setOverflow(SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW);a({msg:"closeGmailThreadView done"})}}}});