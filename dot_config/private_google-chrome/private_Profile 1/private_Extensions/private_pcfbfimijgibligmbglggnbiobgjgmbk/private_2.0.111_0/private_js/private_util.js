/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper.Utils"),Ext.apply(SYNO.SDS.NoteStationClipper.Utils,{DEBUG_FLAG:!1,BETA_FLAG:!1,LOCAL_GIF:"images/transparent.gif",TRANSPARENT_GIF:"webman/3rdparty/NoteStation/images/transparent.gif",getErrorMsg:function(t,e){var n="Failed to send API request";if(e&&e.error&&e.error.code){if("SYNO.API.Auth"===t)switch(e.error.code){case 400:case 402:n=_NSC("login","error_cantlogin");break;case 404:n=_NSC("login","error_otp_failed");break;default:n="Failed to login"}else n="API request failed";n=n+"("+e.error.code+")"}return n},checkInRegArray:function(t,e){for(var n=0;n<e.length;n++)if(Ext.isString(t)&&t.match(e[n]))return!0;return!1},showDebugMessage:function(t){this.DEBUG_FLAG=!0===t},checkIsBeta:function(){return this.BETA_FLAG},debugLog:function(){this.DEBUG_FLAG},isCnRegion:function(){return["Asia/Shanghai","Asia/Urumqi"].includes(Intl.DateTimeFormat().resolvedOptions().timeZone)},GetQuickConnectSiteList:function(t){return new Promise(function(e,n){Ext.Ajax.request({url:String.format("https://global.quickconnect.{0}/Serv.php",t),method:"POST",jsonData:{version:1,command:"get_site_list"},callback:function(t,i,r){i?e(r):n()}})})},GetQuickConnectHost:function(t,e,n,i){var r=0;(SYNO.SDS.NoteStationClipper.Utils.isCnRegion()?SYNO.SDS.NoteStationClipper.Utils.GetQuickConnectSiteList("cn"):Promise.reject()).catch(function(){return SYNO.SDS.NoteStationClipper.Utils.GetQuickConnectSiteList("to")}).then(function(o){var a=Ext.util.JSON.decode(o.responseText);r=a.sites.length,Ext.each(a.sites,function(o){Ext.Ajax.request({url:"https://"+o+"/Serv.php",method:"POST",jsonData:{version:1,command:"get_server_info",id:e?"dsm_portal_https":"dsm_portal",serverID:t},callback:function(o,a,s){var c=Ext.util.JSON.decode(s.responseText);a&&0===c.errno?SYNO.SDS.NoteStationClipper.Utils.setupConnection(c,o,t,e,n,i):0==--r&&n.call(i,!1,{msg:_NSC("quickconnect","cannot_connect_to_ds")})}})})}).catch(function(){n.call(i,!1,{msg:_NSC("quickconnect","cannot_connect_to_global")})})},setupConnection:function(t,e,n,i,r,o){var a,s=i?"https://":"http://",c=SYNO.SDS.NoteStation.Utils.calculateMD5(t.server.serverID),l=[];!1===i&&Ext.each(t.server.interface,function(e){Ext.isEmpty(e.ip)||l.push(s+e.ip+":"+t.service.port)}),a=0===t.service.ext_port?t.service.port:t.service.ext_port,!1===i&&l.push(s+t.server.external.ip+":"+a),Ext.isEmpty(t.server.fqdn)||"NULL"==t.server.fqdn||l.push(s+t.server.fqdn+":"+a),Ext.isString(t.server.ddns)&&!Ext.isEmpty(t.server.ddns)&&"NULL"!==t.server.ddns&&l.push(s+t.server.ddns+":"+a),SYNO.SDS.NoteStationClipper.Utils.batchVerifyConnection({hosts:l,md5:c,fallback:function(){SYNO.SDS.NoteStationClipper.Utils.setupTunnel(e,i,c,n,r,o)},callback:r,scope:o})},setupTunnel:function(t,e,n,i,r,o){t.jsonData.command="request_tunnel",Ext.Ajax.request({url:t.url,method:"POST",jsonData:t.jsonData,callback:function(t,e,a){var s=Ext.util.JSON.decode(a.responseText);if(e&&0===s.errno){var c=[],l=s.env.relay_region;c.push(String.format("https://{0}.{1}.quickconnect.{2}/direct",i,l,/^cn\d+$/.test(l)?"cn":"to")),SYNO.SDS.NoteStationClipper.Utils.batchVerifyConnection({hosts:c,md5:n,fallback:function(){r.call(o,!1,{msg:_NSC("quickconnect","cannot_connect_to_ds")})},callback:r,scope:o})}else r.call(o,!1,{msg:_NSC("quickconnect","cannot_request_tunnel")})}})},batchVerifyConnection:function(t){if(t.numConnection=t.hosts.length,t.numReturn=0,t.connectionSuccess=!1,0===t.numConnection)return void t.fallback();Ext.each(t.hosts,function(e){SYNO.SDS.NoteStationClipper.Utils.verifyConnection(e,t)})},verifyConnection:function(t,e){var n=t+"/webman/pingpong.cgi",i=new XMLHttpRequest;i.onload=function(){var n=Ext.util.JSON.decode(i.responseText);e.numReturn++,200!==i.status||n.ezid!==e.md5||e.connectionSuccess?e.numReturn!==e.numConnection||e.connectionSuccess||e.fallback():(e.connectionSuccess=!0,e.callback.call(e.scope,!0,{host:t}))},i.timeout=2e4,i.ontimeout=function(t){e.connectionSuccess||(e.connectionSuccess=!0,e.fallback())},i.onerror=function(t){++e.numReturn!==e.numConnection||e.connectionSuccess||e.fallback()},i.open("GET",n,!0),i.send()},checkNoteStationVersion:function(t,e,n){var i=t.sid||t.SID,r=t.host||t.HOST;Ext.Ajax.request({url:r+"/webapi/entry.cgi",params:{_sid:Ext.encode(i),api:"SYNO.Entry.Request",method:"request",version:1,stop_when_error:!1,compound:Ext.encode([{api:"SYNO.NoteStation.Info",version:1,method:"get"},{api:"SYNO.NoteStation.Setting",version:1,method:"init"}])},callback:function(t,i,r){e.call(n,i,Ext.util.JSON.decode(r.responseText))}})},isGmail:function(t){var e;return!Ext.isEmpty(t)&&(e=document.createElement("a"),e.href=t,"mail.google.com"===e.hostname)},installGmail:function(t){var e,n,i,r;t&&t.body&&(n=Ext.id(void 0,"SYNO_NoteStationClipper_Gmail_Check_JS"),e=document.createElement("script"),e.id=n,e.innerText='window.postMessage({name: "SYNOGmailGlobals", globals: JSON.stringify(window.GLOBALS) }, "*");',e.innerText+='document.body.removeChild(document.getElementById("'+n+'"));',t.body.appendChild(e),r=Ext.id(void 0,"SYNO_NoteStationClipper_GMAIL_CSS"),i=document.createElement("link"),i.id=r,i.href=chrome.runtime.getURL("css/gmail_thread.css"),i.rel="stylesheet",i.type="text/css",t.head.appendChild(i))},installUxCSS:function(t){var e,n;t&&t.head&&(n="SYNO_NoteStationClipper_UX_CSS",t.head.querySelector("link#"+n)||(e=document.createElement("link"),e.id=n,e.href=chrome.runtime.getURL("scripts/ext-3.4/ux/ux-all.css"),e.rel="stylesheet",e.type="text/css",t.head.appendChild(e)))},simplifyGmailContent:function(t){var e=document.createElement("div");return e.innerHTML="<br>"+t,Ext.iterate(e.querySelectorAll("div.HOEnZb, .adm, .h5"),function(t){t.parentNode&&t.parentNode.removeChild(t)}),e.innerHTML.trim()},isMailPlus:function(t){var e;return!Ext.isEmpty(t)&&(e=document.createElement("a"),e.href=t.toLowerCase(),(-1!==e.pathname.indexOf("synohdpack")||-1!==e.search.indexOf("synohdpack"))&&-1!==e.search.indexOf("mailclient"))},isMailPlusBody:function(t){return!!Ext.isElement(t)&&Ext.isElement(t.querySelector(".syno-mc-message-panel.syno-mc-message-view, .syno-mc-message-panel .syno-mc-message-list"))},handleHttpSrc:function(t,e){var n,i,r,o;n=t.dom.src,i=n.indexOf("#"),-1!==i&&(n=n.substr(0,i)),i=n.indexOf("?"),-1!==i&&(n=n.substr(0,i)),i=n.lastIndexOf("/"),n=-1===i?(new Date).getTime()+".jpg":n.substr(i+1),Ext.isEmpty(n)&&(n=(new Date).getTime()+".jpg"),i=n.lastIndexOf("."),o=-1===i?".jpg":n.substr(i),n.length>32&&(n=n.substr(0,32)+o),n=Ext.id(void 0,"ns_attach_image_")+n,r=SYNO.SDS.NoteStation.Utils.utf8_to_b64(n),t.dom.setAttribute("ref",r),t.dom.setAttribute("adjust","true"),e[n]={action:"create",format:"url",source:t.dom.src,ref:r,rotate:!1}},handleDataUrlSrc:function(t,e,n){var i,r,o,a;i=t.dom.src.match(/^data:image\/([a-zA-Z0-9]*);base64,/),Ext.isEmpty(i)||(o=Ext.id(void 0,"ns_attach_image_")+(new Date).getTime(),2==i.length?o+="."+i[1]:o+=".jpg",a=t.dom.src,r=Ext.id(void 0,SYNO.SDS.NoteStation.Utils.getRandomString(3))+"_clipper_"+SYNO.SDS.NoteStation.Utils.getRandomString(8),Ext.isEmpty(a)||(t.dom.setAttribute("adjust","true"),t.dom.setAttribute("ref",r),t.dom.setAttribute("src",this.LOCAL_GIF),t.dom.setAttribute("data-mce-src",this.TRANSPARENT_GIF),e[o]=Ext.apply({action:"create",format:"raw",DataURI:decodeURIComponent(a),name:o,ref:r},n||{})))},getPdfFiles:function(t,e){var n=e.body||e;return Ext.isObject(t)||(t={}),Ext.iterate(n.querySelectorAll('embed[type="application/pdf"]'),function(e){var n=Ext.id(void 0,SYNO.SDS.NoteStation.Utils.getRandomString(3))+"_clipper_pdf_"+SYNO.SDS.NoteStation.Utils.getRandomString(8),i=e.src.split(/[\\/]/).pop(),r=e.cloneNode(!0);-1===i.indexOf(".pdf",i.length-4)&&(i=Ext.id(void 0,"ns_gc_pdf_")+".pdf"),r.setAttribute("pdf_ref",n),r.setAttribute("class","syno-ns-pdf-loading"),e.parentNode.replaceChild(r,e),t[i]={action:"create",format:"url",source:e.src,pdf_ref:n}},this),t},getImageFiles:function(t,e,n){var i,r,o,a={},s=t.body||t,c=document.createElement("a");return Ext.isEmpty(s)?a:(n=n||{},Ext.get(s).select("img").each(function(t){var s;if(!t.hasClass("syno-notestation-image-object")&&(t.addClass("syno-notestation-image-object"),t.addClass("syno-ns-img-from-clipper"),s=t.dom.src,Ext.isString(s)))if(t.dom.setAttribute("src",s),c.href=s,!0===n.is_gmail){var l=Ext.urlDecode(s),u=n.gmail_data.threads[l.th];if(u&&l.attid in u.inline_images){var d=u.inline_images[l.attid];r=l.th+"_img_"+l.attid,i=d.name,o=String.format("clip_img_{0}_{1}",l.th,l.attid)}else r=Ext.id(void 0,"gmail_img_"),i=c.pathname.substr(c.pathname.lastIndexOf("/")+1)||Ext.id()+".png",o=Ext.id(void 0,"clip_img_url_")+i;a[r]={action:"create",format:"raw",name:i,ref:o,rotate:!1,fetch_url:c.href},t.dom.setAttribute("src",this.LOCAL_GIF),t.dom.setAttribute("data-mce-src",this.TRANSPARENT_GIF),t.dom.setAttribute("ref",o),t.dom.setAttribute("adjust","true")}else if(!0===n.is_mailplus&&0===c.href.indexOf("http"))r=Ext.id(void 0,"mailplus_img_"),i=c.pathname.substr(c.pathname.lastIndexOf("/")+1)||Ext.id()+".png",o=t.getAttribute("syno-mc-cid")||Ext.id(void 0,"clip_img_url_"),a[r]={action:"create",format:"raw",name:i,ref:o,rotate:!1,fetch_url:c.href},t.dom.setAttribute("src",this.LOCAL_GIF),t.dom.setAttribute("data-mce-src",this.TRANSPARENT_GIF),t.dom.setAttribute("ref",o),t.dom.setAttribute("adjust","true");else if(Ext.isEmpty(s.match(/^http[s]?:/i))){if(Ext.isEmpty(s.match(/^data:image\/[a-zA-z0-9]*;base64/)))return;SYNO.SDS.NoteStationClipper.Utils.handleDataUrlSrc(t,a,e)}else SYNO.SDS.NoteStationClipper.Utils.handleHttpSrc(t,a)}),s.removeAttribute("id"),a)},getAPIInfo:function(t,e){Ext.Ajax.request({url:t+"/webapi/query.cgi",params:{api:"SYNO.API.Info",version:1,method:"query",query:"SYNO.API.Auth"},callback:e})}}),Ext.ns("SYNO.SDS.NoteStation.Utils"),Ext.apply(SYNO.SDS.NoteStation.Utils,{utf8_to_b64:function(t){return window.btoa(window.unescape(window.encodeURIComponent(t)))},calculateMD5:function(t){var e;e="0123456789abcdef".split("");var n=function(t,e){var n=t[0],i=t[1],c=t[2],l=t[3];n=r(n,i,c,l,e[0],7,-680876936),l=r(l,n,i,c,e[1],12,-389564586),c=r(c,l,n,i,e[2],17,606105819),i=r(i,c,l,n,e[3],22,-1044525330),n=r(n,i,c,l,e[4],7,-176418897),l=r(l,n,i,c,e[5],12,1200080426),c=r(c,l,n,i,e[6],17,-1473231341),i=r(i,c,l,n,e[7],22,-45705983),n=r(n,i,c,l,e[8],7,1770035416),l=r(l,n,i,c,e[9],12,-1958414417),c=r(c,l,n,i,e[10],17,-42063),i=r(i,c,l,n,e[11],22,-1990404162),n=r(n,i,c,l,e[12],7,1804603682),l=r(l,n,i,c,e[13],12,-40341101),c=r(c,l,n,i,e[14],17,-1502002290),i=r(i,c,l,n,e[15],22,1236535329),n=o(n,i,c,l,e[1],5,-165796510),l=o(l,n,i,c,e[6],9,-1069501632),c=o(c,l,n,i,e[11],14,643717713),i=o(i,c,l,n,e[0],20,-373897302),n=o(n,i,c,l,e[5],5,-701558691),l=o(l,n,i,c,e[10],9,38016083),c=o(c,l,n,i,e[15],14,-660478335),i=o(i,c,l,n,e[4],20,-405537848),n=o(n,i,c,l,e[9],5,568446438),l=o(l,n,i,c,e[14],9,-1019803690),c=o(c,l,n,i,e[3],14,-187363961),i=o(i,c,l,n,e[8],20,1163531501),n=o(n,i,c,l,e[13],5,-1444681467),l=o(l,n,i,c,e[2],9,-51403784),c=o(c,l,n,i,e[7],14,1735328473),i=o(i,c,l,n,e[12],20,-1926607734),n=a(n,i,c,l,e[5],4,-378558),l=a(l,n,i,c,e[8],11,-2022574463),c=a(c,l,n,i,e[11],16,1839030562),i=a(i,c,l,n,e[14],23,-35309556),n=a(n,i,c,l,e[1],4,-1530992060),l=a(l,n,i,c,e[4],11,1272893353),c=a(c,l,n,i,e[7],16,-155497632),i=a(i,c,l,n,e[10],23,-1094730640),n=a(n,i,c,l,e[13],4,681279174),l=a(l,n,i,c,e[0],11,-358537222),c=a(c,l,n,i,e[3],16,-722521979),i=a(i,c,l,n,e[6],23,76029189),n=a(n,i,c,l,e[9],4,-640364487),l=a(l,n,i,c,e[12],11,-421815835),c=a(c,l,n,i,e[15],16,530742520),i=a(i,c,l,n,e[2],23,-995338651),n=s(n,i,c,l,e[0],6,-198630844),l=s(l,n,i,c,e[7],10,1126891415),c=s(c,l,n,i,e[14],15,-1416354905),i=s(i,c,l,n,e[5],21,-57434055),n=s(n,i,c,l,e[12],6,1700485571),l=s(l,n,i,c,e[3],10,-1894986606),c=s(c,l,n,i,e[10],15,-1051523),i=s(i,c,l,n,e[1],21,-2054922799),n=s(n,i,c,l,e[8],6,1873313359),l=s(l,n,i,c,e[15],10,-30611744),c=s(c,l,n,i,e[6],15,-1560198380),i=s(i,c,l,n,e[13],21,1309151649),n=s(n,i,c,l,e[4],6,-145523070),l=s(l,n,i,c,e[11],10,-1120210379),c=s(c,l,n,i,e[2],15,718787259),i=s(i,c,l,n,e[9],21,-343485551),t[0]=p(n,t[0]),t[1]=p(i,t[1]),t[2]=p(c,t[2]),t[3]=p(l,t[3])},i=function(t,e,n,i,r,o){return e=p(p(e,t),p(i,o)),p(e<<r|e>>>32-r,n)},r=function(t,e,n,r,o,a,s){return i(e&n|~e&r,t,e,o,a,s)},o=function(t,e,n,r,o,a,s){return i(e&r|n&~r,t,e,o,a,s)},a=function(t,e,n,r,o,a,s){return i(e^n^r,t,e,o,a,s)},s=function(t,e,n,r,o,a,s){return i(n^(e|~r),t,e,o,a,s)},c=function(t){var e,i=t.length,r=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)n(r,l(t.substring(e-64,e)));t=t.substring(e-64);var o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)o[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(o[e>>2]|=128<<(e%4<<3),e>55)for(n(r,o),e=0;e<16;e++)o[e]=0;return o[14]=8*i,n(r,o),r},l=function(t){var e,n=[];for(e=0;e<64;e+=4)n[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return n},u=function(t){var n,i;for(n="",i=0;i<4;i++)n+=e[t>>8*i+4&15]+e[t>>8*i&15];return n},d=function(t){var e;for(e=0;e<t.length;e++)t[e]=u(t[e]);return t.join("")},m=function(t){return d(c(t))},p=function(t,e){return t+e&4294967295};return"5d41402abc4b2a76b9719d911017c592"!==m("hello")&&(p=function(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n},"5d41402abc4b2a76b9719d911017c592"!==m("hello")&&SYNO.Debug("calculateMD5 self test failed")),m(t)},dataURItoBlob:function(t){var e,n,i,r;try{e=t.split(",")[0].split(":")[1].split(";")[0],n=window.atob(t.split(",")[1])}catch(t){e="image/gif",n=window.atob("R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")}i=new ArrayBuffer(n.length),r=new Uint8Array(i);for(var o=0;o<n.length;o++)r[o]=n.charCodeAt(o);return new Blob([i],{type:e})},getRandomString:function(t){return(new Date*Math.random()).toString(36).replace(".","A").substr(0,t)},checkTagIsParent:function(t,e){return t!==e&&0===e.indexOf(t)&&("/"===e[t.length]||"/"===e[t.length-1])},getTagChild:function(t,e){if(Ext.isEmpty(e))return t;var n=t.substr(e.length),i=SYNO.SDS.NoteStation.Utils.isSeparatorTag(n),r="/"===e[e.length-1];return i||r?n:n.substr(1)},isSeparatorTag:function(t){for(var e=0;e<t.length;e++)if("/"!==t[e])return!1;return!0}});
