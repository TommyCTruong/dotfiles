/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper.Screenshot");Ext.apply(SYNO.SDS.NoteStationClipper.Screenshot,{FUNC_KEYUP:Ext.emptyFn,FUNC_MOUSEMOVE:Ext.emptyFn,FUNC_MOUSEDOWN:Ext.emptyFn,FUNC_MOUSEUP:Ext.emptyFn,FUNC_STOP_CAPTURE:Ext.emptyFn,FUNC_WINSCROLL:Ext.emptyFn,focus_start:null,stop_capture:true,last_mouse_pos:null,onKeyUp:function(b){if(b.keyCode===27){var a=document.getElementById("SYNO_NoteStationClipper_Screenshot_Mask");var c=document.getElementById("SYNO_NoteStationClipper_Screenshot_Focus");document.body.removeChild(a);document.body.removeChild(c);window.removeEventListener("keyup",this.FUNC_KEYUP);window.removeEventListener("mousemove",this.FUNC_MOUSEMOVE);window.removeEventListener("mousedown",this.FUNC_MOUSEDOWN);window.removeEventListener("mouseup",this.FUNC_MOUSEUP);window.removeEventListener("scroll",this.FUNC_WINSCROLL);SYNO.SDS.NoteStationClipper.Clipper.showClipperFrame();chrome.runtime.sendMessage({action:"select_clip_type",type:"fullpage"})}},onScroll:function(a){if(Ext.isEmpty(this.last_mouse_pos)){return}this.onMouseMove({clientX:this.last_mouse_pos.x,clientY:this.last_mouse_pos.y})},onMouseMove:function(b){var a=document.getElementById("SYNO_NoteStationClipper_Screenshot_Mask");var d=document.getElementById("SYNO_NoteStationClipper_Screenshot_Focus");if(Ext.isEmpty(d)||Ext.isEmpty(a)){return}d.style.left=b.clientX+"px";d.style.top=b.clientY+"px";if(Ext.isEmpty(this.focus_start)){return}this.last_mouse_pos={x:b.clientX,y:b.clientY};var e=Math.max(b.clientX,this.focus_start.x);var g=Math.min(b.clientX,this.focus_start.x);var f=Math.min(this.focus_start.originalY+this.focus_start.y,window.scrollY+b.clientY);var c=Math.max(this.focus_start.originalY+this.focus_start.y,window.scrollY+b.clientY);a.style.borderRightWidth=Ext.fly(document.body).getWidth()-e+"px";a.style.borderLeftWidth=g+"px";if(f<=window.scrollY){a.style.borderTopWidth="0px"}else{a.style.borderTopWidth=f-window.scrollY+"px"}if(c>=window.scrollY+window.innerHeight){a.style.borderBottomWidth="0px"}else{a.style.borderBottomWidth=window.scrollY+window.innerHeight-c+"px"}},onMouseDown:function(b){var a=document.getElementById("SYNO_NoteStationClipper_Screenshot_Mask");this.originalSelectStyle=Ext.fly(document.body).getStyle("-webkit-user-select");Ext.fly(document.body).setStyle("-webkit-user-select","none");if(Ext.isEmpty(a)){return}this.focus_start={x:b.clientX,y:b.clientY,originalX:window.scrollX,originalY:window.scrollY};a.style.borderTopWidth=b.clientY+"px";a.style.borderRightWidth=window.innerWidth-b.clientX+"px";a.style.borderBottomWidth=window.innerHeight-b.clientY+"px";a.style.borderLeftWidth=b.clientX+"px"},onMouseUp:function(i){var b=document.getElementById("SYNO_NoteStationClipper_Screenshot_Mask");var f=document.getElementById("SYNO_NoteStationClipper_Screenshot_Focus");document.body.removeChild(b);document.body.removeChild(f);window.removeEventListener("keyup",this.FUNC_KEYUP);window.removeEventListener("mousemove",this.FUNC_MOUSEMOVE);window.removeEventListener("mousedown",this.FUNC_MOUSEDOWN);window.removeEventListener("mouseup",this.FUNC_MOUSEUP);window.removeEventListener("scroll",this.FUNC_WINSCROLL);var g=Math.min(this.focus_start.originalY+this.focus_start.y,window.scrollY+i.clientY);var h=Math.max(this.focus_start.originalX+this.focus_start.x,window.scrollX+i.clientX);var a=Math.max(this.focus_start.originalY+this.focus_start.y,window.scrollY+i.clientY);var e=Math.min(this.focus_start.originalX+this.focus_start.x,window.scrollX+i.clientX);var d={top:g,right:h,bottom:a,left:e,width:h-e+1,height:a-g+1,scrollUnitX:window.innerWidth,scrollUnitY:window.innerHeight,currentX:0,currentY:g,originalScrollX:window.scrollX,originalScrollY:window.scrollY,originalOverflowStyle:document.documentElement.style.overflow,scale:window.devicePixelRatio&&window.devicePixelRatio!==1?1/window.devicePixelRatio:1};var c=document.createElement("canvas");c.width=d.width;c.height=d.height;this.focus_start=null;this.last_mouse_pos=null;this.stop_capture=false;this.FUNC_STOP_CAPTURE=this.onStopCapture.createDelegate(this);window.addEventListener("click",this.FUNC_STOP_CAPTURE);this.getPartialScreenshot(d,c,undefined,function(j){SYNO.SDS.NoteStationClipper.Screenshot.openImageView(j.canvas)})},openImageView:function(c){SYNO.SDS.NoteStationClipper.Clipper.showClipperFrame();Ext.fly(document.body).setOverflow(SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW);var e=document.createElement("div");e.setAttribute("id","SYNO_NoteStationClipper_Screenshot_Image");var b=document.createElement("img");var a=c.getAttribute("height");var d=a>window.innerHeight?0:(window.innerHeight-a)/2;b.setAttribute("src",c.toDataURL("image/jpeg",1));b.setAttribute("style","margin-top: "+d+"px");e.appendChild(b);document.body.appendChild(e);if(null===document.getElementById("SYNO_NoteStationClipper_Clipper_Frame")){chrome.storage.sync.get("clipper_options",function(f){SYNO.SDS.NoteStationClipper.Clipper.getScreenShot({title:undefined,type:"screenshot",notebook_id:f.clipper_options.notebookid},"screenshot")})}},openScreenshotView:function(b){SYNO.SDS.NoteStationClipper.Clipper.hideClipperFrame();var a=document.createElement("div");var c=document.createElement("div");a.setAttribute("id","SYNO_NoteStationClipper_Screenshot_Mask");c.setAttribute("id","SYNO_NoteStationClipper_Screenshot_Focus");a.setAttribute("style","border-width: 0 0 "+window.innerHeight+"px 0;");document.body.appendChild(a);document.body.appendChild(c);this.FUNC_KEYUP=this.onKeyUp.createDelegate(this);this.FUNC_MOUSEMOVE=this.onMouseMove.createDelegate(this);this.FUNC_MOUSEDOWN=this.onMouseDown.createDelegate(this);this.FUNC_MOUSEUP=this.onMouseUp.createDelegate(this);this.FUNC_WINSCROLL=this.onScroll.createDelegate(this);window.addEventListener("keyup",this.FUNC_KEYUP);window.addEventListener("mousemove",this.FUNC_MOUSEMOVE);window.addEventListener("mousedown",this.FUNC_MOUSEDOWN);window.addEventListener("mouseup",this.FUNC_MOUSEUP);window.addEventListener("scroll",this.FUNC_WINSCROLL);document.activeElement.blur();b({msg:"openScreenshotView done"})},toggleScreenshotView:function(d,b){var a=document.getElementById("SYNO_NoteStationClipper_Screenshot_Mask");var c=document.getElementById("SYNO_NoteStationClipper_Screenshot_Focus");var e=document.getElementById("SYNO_NoteStationClipper_Screenshot_Image");if(d&&Ext.isEmpty(a)&&Ext.isEmpty(c)){if(!Ext.isEmpty(e)){document.body.removeChild(e)}this.openScreenshotView(b)}else{if(!d){if(!Ext.isEmpty(a)){document.body.removeChild(a)}if(!Ext.isEmpty(c)){document.body.removeChild(c)}if(!Ext.isEmpty(e)){document.body.removeChild(e)}b({msg:"closeScreenshotView done"})}}},getPartialScreenshot:function(c,a,b,d){if(this.stop_capture){window.scrollTo(c.originalScrollX,c.originalScrollY);document.documentElement.style.overflow=c.originalOverflowStyle;Ext.fly(document.body).setStyle("-webkit-user-select",this.originalSelectStyle);window.removeEventListener("click",this.FUNC_STOP_CAPTURE);return}if(c.currentY>=c.bottom){window.scrollTo(c.originalScrollX,c.originalScrollY);document.documentElement.style.overflow=c.originalOverflowStyle;Ext.fly(document.body).setStyle("-webkit-user-select",this.originalSelectStyle);window.removeEventListener("click",this.FUNC_STOP_CAPTURE);d({canvas:a,data:b,info:c});return}window.scrollTo(c.currentX,c.currentY);window.setTimeout(function(){chrome.runtime.sendMessage({action:"get_screenshot"},function(f){var e=new Image();e.onload=function(){console.log(c);var j=c.left;var h=window.scrollY>=c.top?0:c.top-window.scrollY;var g=c.currentX;var i=window.scrollY<=c.top?0:window.scrollY-c.top;console.log(j,h,c.width/c.scale,c.height/c.scale,g,i,c.width,c.height);a.getContext("2d").drawImage(e,j/c.scale,h/c.scale,c.width/c.scale,c.height/c.scale,g,i,c.width,c.height);c.currentY+=c.scrollUnitY;SYNO.SDS.NoteStationClipper.Screenshot.getPartialScreenshot(c,a,b,d)};e.src=f.screenshotUrl})},500)},onStopCapture:function(){this.stop_capture=true},getMaxFromArr:function(a){var b=0;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b},getMaxWidth:function(){var a=[document.documentElement.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.body.scrollWidth,document.body.offsetWidth];return this.getMaxFromArr(a)},getMaxHeight:function(){var a=[document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.body.scrollHeight,document.body.offsetHeight];return this.getMaxFromArr(a)},getFullScreenshot:function(b,d){var c={top:0,right:this.getMaxWidth(),bottom:this.getMaxHeight(),left:0,scrollUnitX:window.innerWidth,scrollUnitY:window.innerHeight,currentX:0,currentY:0,originalScrollX:window.scrollX,originalScrollY:window.scrollY,originalOverflowStyle:document.documentElement.style.overflow,scale:window.devicePixelRatio&&window.devicePixelRatio!==1?1/window.devicePixelRatio:1};c.width=c.right-c.left+1;c.height=c.bottom-c.top+1;var a=document.createElement("canvas");a.width=c.width;a.height=c.height;SYNO.SDS.NoteStationClipper.Clipper.closeClipperFrame();document.documentElement.style.overflow="hidden";this.stop_capture=false;this.FUNC_STOP_CAPTURE=this.onStopCapture.createDelegate(this);window.addEventListener("click",this.FUNC_STOP_CAPTURE);this.getPartialScreenshot(c,a,b,d)}});