/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper");Ext.define("SYNO.SDS.NoteStationClipper.StatusDialog",{extend:"SYNO.SDS.BaseWindow",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var c=Ext.urlDecode(window.location.search.substr(1));this.status=c.status;this.noteid=c.object_id;this.notever=c.ver;var b=Ext.apply({width:300,height:200,padding:"0px 12px",layout:"fit",maximizable:false,minimizable:false,closable:true,resizable:false,draggable:false,cls:"syno-nsc-status-dialog",items:[this.formPanel=new SYNO.ux.FormPanel({labelWidth:30,useGradient:false,items:[{xtype:"syno_displayfield",cls:this.getStatusCls(),height:36,value:window.decodeURIComponent(c.text),htmlEncode:true},{xtype:"syno_displayfield",cls:"syno-nsc-status-desc",value:window.decodeURIComponent(c.desc),htmlEncode:true},{xtype:"syno_displayfield",height:10,itemCls:"syno-nsc-status-sep-item",hidden:this.status!=="success"},this.tagsField=new SYNO.SDS.NoteStationClipper.TagSuperBox({hidden:this.status!=="success",supportNestedTag:a.ns_version>=520,listeners:{scope:this,focus:this.cancelCloseCounter,blur:this.restartCloseCounter,additem:this.updateFormScroller,removeitem:this.updateFormScroller,newitem:this.onAddNewitem}})]})],listeners:{scope:this,activate:this.onWindowActivate}},a);return b},onWindowClosed:Ext.emptyFn,onWindowActivate:function(){if(this.status==="success"||this.status==="failure"){this.autoCloseTask=new Ext.util.DelayedTask(this.close,this);this.autoCloseTask.delay(3500)}if(this.status==="success"){this.loadAllTags()}},loadAllTags:function(){this.formPanel.el.mask(_NSC("common","loading"),"x-mask-loading");chrome.runtime.sendMessage({action:"ajax_request",data:{api:"SYNO.NoteStation.Tag",version:1,method:"list"}},this.loadTagCallback.createDelegate(this))},loadTagCallback:function(b){if(b.success){var a=[];var c=Ext.util.JSON.decode(b.response.responseText);Ext.each(c.data.tags,function(d){a.push(new Ext.data.Record({tag_id:d.tag_id,title:d.title}))},this);this.tagsField.getTagStore().add(a);chrome.runtime.sendMessage({action:"ajax_request",data:{api:"SYNO.NoteStation.Note",version:2,method:"get",params:{object_id:this.noteid}}},this.loadNoteInfoCallback.createDelegate(this))}else{this.formPanel.el.unmask();alert("failed to load tags")}},loadNoteInfoCallback:function(b){this.formPanel.el.unmask();if(!b.success){alert("failed to load note info")}else{var c=Ext.util.JSON.decode(b.response.responseText);var a=[];Ext.each(c.data.tag,function(d){a.push({tag_id:d+"@"+this.uid,title:d})},this);this.tagsField.setValueEx(a)}},saveTags:function(){chrome.runtime.sendMessage({action:"ajax_request",data:{api:"SYNO.NoteStation.Note",version:2,method:"set",params:{object_id:this.noteid,ver:this.notever,tag:this.getTagsArray()}}},this.saveTagCallback.createDelegate(this))},saveTagCallback:function(a){if(!a.success){alert("failed to load tags")}else{var b=Ext.util.JSON.decode(a.response.responseText);this.notever=b.data.data[0].ver}},getTagsArray:function(){var b=this.tagsField.getValueEx();var a=[];Ext.each(b,function(c){a.push(c.title)});return a},updateFormScroller:function(){this.formPanel.updateScroller()},onAddNewitem:function(b,a,c){a=a.trim();if(a){b.addItem({tag_id:a+"@"+this.uid,title:a},true)}this.formPanel.updateScroller()},restartCloseCounter:function(){this.saveTags();if(!Ext.isEmpty(this.autoCloseTask)){this.autoCloseTask.delay(3000)}},cancelCloseCounter:function(){if(!Ext.isEmpty(this.autoCloseTask)){this.autoCloseTask.cancel()}},close:function(){this.cancelCloseCounter();chrome.runtime.sendMessage({action:"close_status"});this.callParent(arguments)},getStatusCls:function(){var a;switch(this.status){case"success":a="syno-nsc-status-success";break;case"failure":a="syno-nsc-status-failure";break;case"processing":a="syno-nsc-status-processing";break;default:a="syno-nsc-status-processing";break}return a}});Ext.onReady(function(){Ext.QuickTips.init();chrome.runtime.sendMessage({action:"get_appinfo"},function(d){var a=0,b=0;try{a=parseInt(d.version.build,10);b=d.uid}catch(c){}window.StatusDialog=new SYNO.SDS.NoteStationClipper.StatusDialog({uid:b,ns_version:a}).show()})});