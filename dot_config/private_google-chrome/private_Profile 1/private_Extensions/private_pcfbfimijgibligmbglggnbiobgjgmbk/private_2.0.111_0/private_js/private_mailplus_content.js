/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper.MailPlus");Ext.apply(SYNO.SDS.NoteStationClipper.MailPlus,{choose_id:"SYNO_NoteStationClipper_MailPlus_Thread",convertToImgAbsolutePath:function(e,c){var b=document.createElement("a"),d=document.createElement("div");var a="";if(c){a="SynoToken="+c}Ext.iterate(e,function(f){d.innerHTML=f.body.html;Ext.iterate(d.querySelectorAll("img[src]"),function(g){b.href=g.src;if(0===b.href.indexOf("http")){g.src=Ext.urlAppend(b.href,a)}else{g.src=b.href}});f.body.html=d.innerHTML});return e},fetchData:function(d){var c=false,b=document.createElement("a");var a=document.body.querySelectorAll(".syno-mc-message-panel.syno-mc-message-view [syno-mc-data-message-id]");if(a.length===0){a=document.body.querySelectorAll(".syno-mc-message-panel .syno-mc-message-list [syno-mc-data-message-id]")}if(-1!==window.location.pathname.indexOf("/webman")){c=true;b.href="/webapi/entry.cgi"}else{b.href="webapi/entry.cgi"}Ext.Ajax.request({url:c?"login.cgi":"webman/login.cgi",callback:function(i,e,j){var h="",g=[],f;if(true===e){j=Ext.decode(j.responseText);if(true===j.success){h=j.SynoToken}}Ext.iterate(a,function(l){var k=l.getAttribute("syno-mc-data-message-id");if(Ext.isEmpty(k)){return}g.push(parseInt(k,10))});f=b.href;if(!Ext.isEmpty(h)){f=Ext.urlAppend(f,"SynoToken="+h)}else{h=""}Ext.Ajax.request({url:f,params:{api:"SYNO.MailClient.Message",method:"get",version:1,id:Ext.encode(g)},callback:function(l,k,n){var m;n=Ext.decode(n.responseText);if(!Ext.isObject(n)||true!==n.success){m=[]}else{m=n.data.message}d({title:document.body.querySelector(".syno-mc-message-panel .subject").textContent,messages:SYNO.SDS.NoteStationClipper.MailPlus.convertToImgAbsolutePath(m,h),token:h,baseUrl:b.href})}})}})},openMailPlusThreadView:function(c,a){var b;b=document.createElement("iframe");b.setAttribute("id",this.choose_id);b.setAttribute("frameborder","0");document.body.appendChild(b);b.onload=function(){SYNO.SDS.NoteStationClipper.MailPlus.fetchData(function(d){b.contentWindow.postMessage({action:"init_mailplus",data:d},b.src);a({msg:"openMailPlusView done"})})};b.src=chrome.extension.getURL("mailplus.html")+"?origin="+window.location.origin;Ext.fly(document.body).setOverflow("hidden")},toggleMailPlusThreadView:function(b,d,a){var c=document.getElementById(this.choose_id);if(b&&Ext.isEmpty(c)){this.openMailPlusThreadView(d,a)}else{if(!b&&!Ext.isEmpty(c)){document.body.removeChild(c);Ext.fly(document.body).setOverflow(SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW);this.mail_panel=null;this.mail_data=null;a({msg:"closeMailPlusThreadView done"})}}}});