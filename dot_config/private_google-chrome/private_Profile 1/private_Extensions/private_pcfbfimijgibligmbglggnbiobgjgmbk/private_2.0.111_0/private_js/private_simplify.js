/* Copyright (c) 2022 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.NoteStationClipper.Simplify");Ext.apply(SYNO.SDS.NoteStationClipper.Simplify,{getNodeTagType:function(a){return(a.nodeType===3?"#text":((a.nodeType===1&&Ext.isString(a.tagName))?a.tagName.toLowerCase():"#undefined"))},checkNodeIsContainer:function(a){return"|body|article|section|div|td|li|dd|dt|main|".indexOf("|"+a+"|")>=0},checkNodeIsMainContainer:function(a){return"|body|article|section|div|main|".indexOf("|"+a+"|")>=0},getSimplifyContentByReadability:function(){var a,d;var c,b;Ext.iterate(document.body.querySelectorAll("img"),function(f){var g=f.width||f.naturalWidth;var e=f.height||f.naturalHeight;var h=0;if(!Ext.isNumber(g)||!Ext.isNumber(e)){return}h=g/150+e/150-Math.abs(g-e)/50;if(h<1){return}f.setAttribute("syno_nsc_img_node_size_score",h)});a=document.cloneNode(true);b={spec:location.href,host:location.host,prePath:location.protocol+"//"+location.host,scheme:location.protocol.substr(0,location.protocol.indexOf(":")),pathBase:location.protocol+"//"+location.host+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)};c=new Readability(b,a).parse();if(c){d=document.createElement("div");d.className+="syno-clipper-reader-container ";d.innerHTML='<span class="syno-clipper-reader-title">'+c.title+"</span><hr/>"+c.content}return d},getSimplifyContent:function(){var a=this.getMostInformativeNode();var b=SYNO.SDS.NoteStationClipper.Clipper.getArticleTitle();this.removeArticleTitleFromContent(a,b.trim());var c=document.createElement("div");c.className+="syno-clipper-reader-container ";a.innerHTML='<span class="syno-clipper-reader-title">'+b+"</span><hr/>"+a.innerHTML;c.appendChild(a);return c},removeArticleTitleFromContent:function(b,c){for(var a=0;a<b.childNodes.length;a++){var d=b.childNodes[a];if(Ext.isEmpty(d.innerText)){continue}if(d.innerText.trim()===c){b.removeChild(d);return true}if(this.removeArticleTitleFromContent(d,c)){return true}}return false},addSchemaNodeAttribute:function(b){var e,d,c,g=false,f=SYNO.SDS.NoteStationClipper.Utils;var a=[[new RegExp("articlebody","i"),new RegExp("articlesection","i"),new RegExp("text","i")],[new RegExp(".*schema.org/MedicalScholarlyArticle","i"),new RegExp(".*schema.org/APIReference","i")],[new RegExp(".*schema.org/BlogPosting","i"),new RegExp(".*schema.org/NewsArticle","i"),new RegExp(".*schema.org/ScholarlyArticle","i"),new RegExp(".*schema.org/TechArticle","i")]];e=b.querySelectorAll("*[itemtype], *[itemprop]");for(d=0;d<a.length;d++){g=false;for(c=0;c<e.length;c++){if(f.checkInRegArray(e[c].getAttribute("itemtype"),a[d])){e[c].setAttribute("syno_nsc_schema_node",true);g=true}else{if(f.checkInRegArray(e[c].getAttribute("itemprop"),a[d])){e[c].setAttribute("syno_nsc_schema_node",true);g=true}}}if(true===g){break}}return g},clearSynoAttribute:function(b){for(var a=0;a<b.childNodes.length;a++){var c=b.childNodes[a];if(Ext.isFunction(c.removeAttribute)){c.removeAttribute("syno_nsc_removeable_node");c.removeAttribute("syno_nsc_preserve_node");c.removeAttribute("syno_nsc_schema_node")}this.clearSynoAttribute(c)}},addRemoveableAttribute:function(g){var j=false;for(var h=0;h<g.childNodes.length;h++){var e=g.childNodes[h];var l=this.getNodeTagType(e);var d=this.checkNodeIsContainer(l);var k=false;var f=Ext.fly(e);var c=Ext.isEmpty(f)?0:Ext.fly(e).getWidth();var m=Ext.isEmpty(f)?0:Ext.fly(e).getHeight();if(Ext.isFunction(e.getAttribute)&&e.getAttribute("syno_nsc_preserve_node")){continue}var b=(e.nodeType===1&&Ext.isString(e.tagName)&&Ext.isFunction(window.getComputedStyle))?window.getComputedStyle(e,null):e.style;if(d&&(b.display==="none"||(c*m>10&&c*m<3600))){j=false;k=true}else{if(l==="img"&&(c<=100||m<=100||e.naturalWidth<=10||e.naturalHeight<=10)){j=false;k=true}else{if(l==="a"){var a=e.getAttribute("href");if(e.querySelector("img")){j=false}else{if(Ext.isEmpty(a)||/^#.*$/.test(a)||!/^.*[a-zA-Z0-9.\/]+.*$/.test(a)){j=true;k=true}else{j=false}}}else{if(l==="br"&&j){j=false;k=true}else{if(l==="nav"){j=false;k=true}else{j=false}}}}}if(Ext.isFunction(e.setAttribute)&&k){e.setAttribute("syno_nsc_removeable_node","true")}if(l==="table"){continue}this.addRemoveableAttribute(e)}},addPreservableAttribute:function(d){var e,a,c,b;if(!Ext.isElement(d)){return}e=d.querySelectorAll("a > img");for(c=0;c<e.length;c++){if(200<parseFloat(e[c].width)&&200<parseFloat(e[c].height)){e[c].setAttribute("syno_nsc_preserve_node","true")}}b=function(g,f){Ext.iterate(g.childNodes,function(h){if(h===f||!Ext.isElement(h)){return}if(h.hasAttribute("syno_nsc_preserve_node")||h.hasAttribute("syno_nsc_removeable_node")){return}h.setAttribute("syno_nsc_removeable_node","true")});g.removeAttribute("syno_nsc_removeable_node");g.setAttribute("syno_nsc_preserve_node","true")};a=d.querySelectorAll('*[syno_nsc_removeable_node="true"] *[syno_nsc_preserve_node="true"]');Ext.iterate(a,function(g){var f=g;while(f.parentNode!=document.body){if("true"===f.parentNode.getAttribute("syno_nsc_removeable_node")){b(f.parentNode,f)}f=f.parentNode}})},mergeSchemaNode:function(b,d){for(var a=0;a<b.childNodes.length;a++){var c=b.childNodes[a];if(Ext.isFunction(c.getAttribute)&&c.getAttribute("syno_nsc_schema_node")){d.appendChild(c.cloneNode(true))}else{this.mergeSchemaNode(b.childNodes[a],d)}}},isBrokenSchemaWebSite:function(){var a=document.location.host;if(-1!==a.indexOf("tomsguide.com")||-1!==a.indexOf("tomshardware")){return true}return false},getMostInformativeNode:function(){var a,b,c,d;this.clearSynoAttribute(document.body);this.updateGrayImageSrc(document.body);this.addRemoveableAttribute(document.body);this.addPreservableAttribute(document.body);a=document.cloneNode(true).body;this.removeUselessNode(a);b=this.recursiveGetNodeFeature(a);this.removeNoisyNode(a,b);c={node:null,score:0};if(!this.isBrokenSchemaWebSite()&&this.addSchemaNodeAttribute(a)){d=document.createElement("div");this.mergeSchemaNode(a,d)}else{d=this.getSimplifyContentByReadability()}if(Ext.isElement(d)&&!Ext.isEmpty(d.innerText)){c.node=d}else{this.recursiveCalculateScore(a,b,c)}SYNO.SDS.NoteStationClipper.Utils.debugLog("===== final candidate is ",c);return Ext.isEmpty(c.node)?a:c.node},checkNodeTypeRemovable:function(d){var a=this.getNodeTagType(d);var b=false;if(Ext.isFunction(d.getAttribute)&&d.getAttribute("syno_nsc_removeable_node")==="true"){return true}switch(a){case"iframe":var c="((http://)?)(www\\.)?((youtube\\.com/)|(youtu\\.be)|(youtube)).+";if(d.src.match(c)&&-1===d.src.indexOf("/subscribe_embed")){d.setAttribute("src",d.src);if(!d.hasAttribute("width")&&!d.hasAttribute("height")){d.setAttribute("width",640);d.setAttribute("height",360)}}else{b=true}break;case"script":case"embed":case"style":case"object":case"aside":case"noscript":case"meta":case"textarea":case"select":case"input":case"button":b=true;break;default:break}return b},updateGrayImageSrc:function(c){var d=c.querySelectorAll("img[original], img[data-origin], img[data-original], img[data-src]");for(var b=0;b<d.length;b++){var a=d[b];if(!Ext.isEmpty(a.getAttribute("original"))){a.setAttribute("src",a.getAttribute("original"));a.removeAttribute("original")}else{if(!Ext.isEmpty(a.getAttribute("data-origin"))){a.setAttribute("src",a.getAttribute("data-origin"));a.removeAttribute("data-origin")}else{if(!Ext.isEmpty(a.getAttribute("data-original"))){a.setAttribute("src",a.getAttribute("data-original"));a.removeAttribute("data-original")}else{if(!Ext.isEmpty(a.getAttribute("data-src"))){a.setAttribute("src",a.getAttribute("data-src"));a.removeAttribute("data-src")}else{continue}}}}a.setAttribute("syno_nsc_preserve_node","true")}return d.length>0},removeUselessNode:function(c){if(Ext.isFunction(c.removeAttribute)){var a=["id","class","style","bgcolor","onclick","oncontextmenu","ondblclick","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseover","onmouseout","onmouseup","onkeydown","onkeypress","onkeyup","onabort","onbeforeunload","onerror","onhashchange","onload","onpageshow","onpagehide","onresize","onscroll","onunload","onblur","onchange","onfocus","onfocusin","onfocusout","oninput","oninvalid","onreset","onsearch","onselect","onsubmit","ondrag","ondragend","ondragenter","ondragleave","ondragover","ondragstart","ondrop","oncopy","oncut","onpaste","onafterprint","onbeforeprint","onabort","oncanplay","oncanplaythrough","ondurationchange","onemptied","onended","onerror","onloadeddata","onloadedmetadata","onloadstart","onpause","onplay","onplaying","onprogress","onratechange","onseeked","onseeking","onstalled","onsuspend","ontimeupdate","onvolumechange","onwaiting","onerror","onmessage","onopen","onmessage","onmousewheel","ononline","onoffline","onpopstate","onshow","onstorage","ontoggle","onwheel","ontouchcancel","ontouchend","ontouchmove","ontouchstart"];Ext.each(a,function(d){c.removeAttribute(d)})}for(var b=0;b<c.childNodes.length;b++){if(this.checkNodeTypeRemovable(c.childNodes[b])){c.removeChild(c.childNodes[b]);b--}else{this.removeUselessNode(c.childNodes[b])}}return},getFeatureWordCount:function(b){b=b.replace(/(^\s*)|(\s*$)/gi,"");b=b.replace(/[ ]{2,}/gi," ");b=b.replace(/\n /,"\n");var a=b.match(/[\u00ff-\uffff]|\S+/g);return !Ext.isArray(a)?0:a.length},getFeatureTextLength:function(a){a=a.replace(/[\s\r\n]+/gi,"");return a.length},getFeatureEntropy:function(e,d,g,a){if(e.childNodes.length===1){return e.childNodes[0]._syno_nsc_feature[d]}var b=0;if(e._syno_nsc_feature[g]>0){for(var c=0;c<a.length;c++){if(a[c]===0){continue}var f=a[c]/e._syno_nsc_feature[g];b+=-1*(f*Math.log(f))}}return b},recursiveGetNodeFeature:function(g){var a=this.getNodeTagType(g);g._syno_nsc_feature={text_length:0,word_count:0,img_count:0,link_count:0,link_text_length:0,link_word_count:0,iframe_count:0,video_count:0,paragraph_count:0,paragraph_score:0,entropy_text:0,entropy_word:0,entropy_img:0,entropy_paragraph:0,is_leaf:false,is_container:this.checkNodeIsContainer(a)};switch(a){case"#text":g._syno_nsc_feature.text_length=this.getFeatureTextLength(g.nodeValue);g._syno_nsc_feature.word_count=this.getFeatureWordCount(g.nodeValue);break;case"img":g._syno_nsc_feature.img_count++;break;case"a":g._syno_nsc_feature.link_count++;g._syno_nsc_feature.link_text_length=this.getFeatureTextLength(g.outerText);g._syno_nsc_feature.link_word_count=this.getFeatureWordCount(g.outerText);break;case"p":g._syno_nsc_feature.paragraph_count++;g._syno_nsc_feature.paragraph_score++;break;case"iframe":g._syno_nsc_feature.iframe_count++;break;case"video":g._syno_nsc_feature.video_count++;break;case"source":g.setAttribute("src",g.src);break;default:break}if(g.childNodes.length===0){g._syno_nsc_feature.is_leaf=true;return g._syno_nsc_feature}var c=[],e=[],f=[],h=[];for(var d=0;d<g.childNodes.length;d++){var b=this.recursiveGetNodeFeature(g.childNodes[d]);g._syno_nsc_feature.text_length+=b.text_length;g._syno_nsc_feature.word_count+=b.word_count;g._syno_nsc_feature.img_count+=b.img_count;g._syno_nsc_feature.link_count+=b.link_count;g._syno_nsc_feature.iframe_count+=b.iframe_count;g._syno_nsc_feature.video_count+=b.video_count;g._syno_nsc_feature.link_text_length+=b.link_text_length;g._syno_nsc_feature.link_word_count+=b.link_word_count;g._syno_nsc_feature.paragraph_count+=b.paragraph_count;g._syno_nsc_feature.paragraph_score+=b.paragraph_score*0.8;c.push(b.text_length);e.push(b.word_count);f.push(b.img_count);h.push(b.paragraph_count)}g._syno_nsc_feature.entropy_text=this.getFeatureEntropy(g,"entropy_text","text_length",c);g._syno_nsc_feature.entropy_word=this.getFeatureEntropy(g,"entropy_word","word_count",e);g._syno_nsc_feature.entropy_img=this.getFeatureEntropy(g,"entropy_img","img_count",f);g._syno_nsc_feature.entropy_paragraph=this.getFeatureEntropy(g,"entropy_paragraph","paragraph_count",h);return g._syno_nsc_feature},calculateScore:function(a,b){var c=a.entropy_text*(a.text_length/b.text_length);c+=a.entropy_word*(a.word_count/b.word_count);c+=a.entropy_img*(a.img_count/b.img_count);c+=a.entropy_paragraph*(a.paragraph_count/b.paragraph_count);c+=a.paragraph_score/b.paragraph_count;return c},removeUnpreservableChild:function(c){if(c.childNodes.length===0){return !Ext.isFunction(c.getAttribute)||c.getAttribute("syno_nsc_preserve_node")!=="true"}var a=true;for(var b=0;b<c.childNodes.length;b++){var d=c.childNodes[b];if(this.removeUnpreservableChild(d)){c.removeChild(d);b--}else{a=false}}return a},removeNoisyNode:function(e,j){var g;for(g=0;g<e.childNodes.length;g++){var m=e.childNodes[g]._syno_nsc_feature;var c=e.childNodes[g];var l=this.getNodeTagType(c);var f=this.checkNodeIsMainContainer(l);var k=false;var a=4;var b=0.7+0.3*Math.min(100,m.link_count-a)/100;var h=m.link_text_length/m.text_length;var d=m.link_word_count/m.word_count;if(m.link_count>=a&&(h>b||d>b||m.text_length===0)){SYNO.SDS.NoteStationClipper.Utils.debugLog("----- REMOVE LINK #",m.link_count," ratio ",h,">",b,d);k=true}else{if(f&&m.link_count+m.img_count+m.paragraph_count+m.text_length+m.iframe_count+m.video_count===0){SYNO.SDS.NoteStationClipper.Utils.debugLog("----- REMOVE EMPTY CONTENT");k=true}else{if(l==="li"&&c.innerText.length<5){k=true}}}if(k&&this.removeUnpreservableChild(c)){e.removeChild(c);g--}}for(g=0;g<e.childNodes.length;g++){this.removeNoisyNode(e.childNodes[g])}},recursiveCalculateScore:function(e,b,c){if(!Ext.isEmpty(e._syno_nsc_feature)&&e._syno_nsc_feature.is_container){var d=this.calculateScore(e._syno_nsc_feature,b);if(d>c.score){c.score=d;c.node=e}}for(var a=0;a<e.childNodes.length;a++){this.recursiveCalculateScore(e.childNodes[a],b,c)}return},openSimplifyView:function(a){var b=this.getSimplifyContent();var c=document.createElement("iframe");SYNO.SDS.NoteStationClipper.Clipper.Files=SYNO.SDS.NoteStationClipper.Utils.getImageFiles(b);c.setAttribute("id","SYNO_NoteStationClipper_Simplify_Frame");c.setAttribute("frameborder","0");c.setAttribute("sandbox","allow-same-origin allow-scripts allow-popups allow-forms");document.body.appendChild(c);c.onload=function(){a({msg:"openSimplifyView done"});this.contentWindow.postMessage({action:"set_tinymce_content",content:b.outerHTML},c.src)};c.src=chrome.extension.getURL("simplify.html")+"?origin="+Ext.util.Format.htmlEncode(location.origin);Ext.fly(document.body).setOverflow("hidden")},toggleSimplifyView:function(b,a){var c=document.getElementById("SYNO_NoteStationClipper_Simplify_Frame");if(b&&Ext.isEmpty(c)){this.openSimplifyView(a)}else{if(!b&&!Ext.isEmpty(c)){document.body.removeChild(c);Ext.fly(document.body).setOverflow(SYNO.SDS.NoteStationClipper.Clipper.ORIGINAL_OVERFLOW);a({msg:"closeSimplifyView done"})}}}});